
目的
win10端末からプライベートサブネットに配置されたEC2インスタンスに対して
ssh接続する。

参考
https://www.youtube.com/watch?v=7J_crzU5KP8
https://qiita.com/amakawa_/items/ab7d284566b5fd51d9ca
https://dev.classmethod.jp/articles/bastion-ssh-on-windows/

1.VPC
VPCを作成する

名前:my-vpc-01
IPv4 CIDR ブロック:172.16.1.0/24
VPCを作成

2.サブネット
publicとprivateサブネットを作成する

VPC ID:my-vpc-01
サブネットの設定:
サブネット名:my-subnet-public-01
アベイラビリティゾーン:ap-northeast-a1
IPv4 CIDRブロック:172.16.1.0/25
サブネットを作成

VPC ID:my-vpc-01
サブネットの設定:
サブネット名:my-subnet-private-01
アベイラビリティゾーン:ap-northeast-a1
IPv4 CIDRブロック:172.16.1.128/25
サブネットを作成

3.EC2インスタンスの作成
パブリックサブネットにインスタンスを作成

インスタンスを起動
ステップ 1: Amazon マシンイメージ (AMI):Amazon Linux 2 AMI (HVM)
ステップ 2: インスタンスタイプの選択:t2.micro
ステップ 3: インスタンスの詳細の設定:
インスタンス数:1
ネットワーク:my-vpc-01
サブネット:my-subnet-public-01
自動割り当てパブリック IP:有効
他はそのままで次のステップへ

以下は特に何もせずそのまま次のステップへを選択する
ステップ 4: ストレージの追加
ステップ 5: タグの追加
ステップ 6: セキュリティグループの設定

確認と作成
起動

キーペアはmy-key-pair-01を作成

4.インターネットゲートウェイの作成
VPC
インターネットゲートウェイ
名前タグ:my-igw-01
インターネットゲートウェイの作成

アクション
VPCにアタッチ:my-vpc-01

5.サブネットを編集
VPC
サブネット
my-subent-public-01を選択する
下画面のルートテーブルタブをクリック
ルートテーブル:***をクリック
ルートテーブルの名前を変更:my-rtb-public-01
下画面ルートタブをクリック
ルートの編集
ルートの追加
送信先:0.0.0.0/24 ターゲット:インターネットゲートウェイ（my-ugw-01）
変更を保存

6.EC2インスタンスセキュリティ編集
EC2
先ほど作成済みのEC2インスタンスを選択
下画面のセキュリティタブを選択
セキュリティグループを選択
インバウンドルール
edit inbound rule
インバウンドルール1を編集
タイプ:すべてのトラフィック

7.疎通確認
ping (EC2インスタンスのパブリックIPv4アドレス)
疎通確認が可能

7.プライベートサブネットにEC2インスタンスを作成
インスタンスの起動
ステップ1と2は同様
ステップ3
インスタンス数:1
ネットワーク:my-vpc-01
サブネット:my-subnet-private-01
自動割り当てパブリック IP:無効化
セキュリティグループはすべてのトラフィックを許可
後は同様

8.パブリックサブネットのEC2インスタンスにログインする
今回はwin10端末からTeraTermを使用してログインする
パブリックサブネットのEC2インスタンスのパブリックIPアドレスを入力し、
SSH接続を選択する。
ユーザー名:ec2-user
パスフレーズ:(空欄)
RSA/DSA/ECDSA/ED25519鍵を使うのラジオボタンを選択し、
保存済みの.pemキーを選択する。
OKで接続可能

9.パブリックサブネットのEC2インスタンスからプライベートサブネットの
EC2インスタンスにログインする。

windows10の場合は.pemキーを以下に配置する。
C:\ssh\***.pem

teratermを開き、設定→ssh転送をクリック
ポート転送
追加、ローカルポート:10022
リモート:(privateサブネットのEC2インスタンスのプライベートIPアドレス)
ポート:22
OK
元の画面に戻り、OK

teratermをもう一つ立ち上げて、host:127.0.0.1
tcpポート:10022
OK
でプライベートサブネットに配置されたEC2インスタンスにログイン可能
